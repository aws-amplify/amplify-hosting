<p align="center">
  <a href="https://console.amplify.aws">
    <img alt="Amplify" src="https://github.com/aws-amplify/community/blob/master/src/assets/images/logo-dark.png" width="60" />
  </a>
</p>
<h1 align="center">
  Amplify Console Troubleshooting Guide
</h1>

## Table of contents

- [Builds](#builds)
  - [Build fails with _Cannot find module aws-exports_](#build-fails-with-cannot-find-module-aws-exports)
  - [How do I override a build timeout?](#how-do-i-override-a-build-timeout)
  - [How do I pull private packages during a build?](#how-do-i-pull-private-packages-during-a-build)
  - [How do I run Amplify functions with Python runtime?](#how-do-i-run-amplify-functions-with-python-runtime)
  - [Cache](#cache)
    - [How do I reduce the cache size?](#how-do-i-reduce-the-cache-size)
    - [How do I disable reading from cache?](#how-do-i-disable-reading-from-cache)
- [Redirects](#redirects)
  - [Access denied for certain routes even with SPA redirect rule](#access-denied-for-certain-routes-even-with-spa-redirect-rule)
- [Custom Domains](#custom-domains)
  - [How do I migrate domains to Amplify with minimal downtime?](#how-do-i-migrate-domains-to-amplify-with-minimal-downtime)
  - [CNAMEAlreadyExistsException](#cnamealreadyexistsexception)
- [Web previews](#web-previews)
  - [Previews are not being created for new pull requests](#previews-are-not-being-created-for-new-pull-requests)
- [SSR](#ssr)
  - [Convert an SSR App to SSG](#convert-an-ssr-app-to-ssg)

## Builds

### Build fails with _Cannot find module aws-exports_

The following error is generated when your app cannot find the `aws-exports.js` file.

```tsx
TS2307: Cannot find module 'aws-exports'
```

The `aws-exports.js` file is generated by the Amplify CLI during your backend build. Add the following code snippet to your build spec to resolve the error. This will create the `aws-exports.js` file for use in the build.

```yaml
backend:
  phases:
    build:
      commands:
        - "# Execute Amplify CLI with the helper script"
        - amplifyPush --simple
```

### How do I override a build timeout?

The default build timeout is 30 minutes. You can override the default build timeout using an environment variable: `_BUILD_TIMEOUT` (App settings > Environment variables). The minimum build timeout is 5 minutes.  The maximum build timeout is 120 minutes.

### How do I pull private packages during a build?

Create your own key pair and add the private key as an environment variable in the Amplify app. Add the public key to the repository you would like to clone. You could then add the key to the ssh-agent on the build instance during build and git clone the second repository.

1. Create the keypair without a password:

```sh
ssh-keygen -f deploy_key -N ""
```

2. Encode it and copy the output into an Environment Variable in the Amplify Console (e.g. DEPLOY_KEY)

```sh
cat deploy_key | base64 | tr -d n
```

3. Add the contents of `deploy_key.pub` to the access keys of the private repo that you want to access

4. Then in `amplify.yml`:

```yaml
commands:
  - eval "$(ssh-agent -s)"
  - ssh-add <(echo "$DEPLOY_KEY" | base64 -d)
```

### How do I run Amplify functions with Python runtime?

[Amplify Lambda functions need Python 3.8.x or above](https://docs.amplify.aws/cli/function#supported-lambda-runtimes). Our build image supports both Python 3.7.9 which is aliased under `python3`, and Python 3.8 which is aliased under `python3.8`. In order to you use `python3` with Python 3.8 version, use the following commands (_create symlink to link python3 to python3.8 and install pipenv using pip3.8_).

```yaml
version: 1
backend:
  phases:
    build:
      commands:
        - update-alternatives --install /usr/bin/python3 python3 /usr/local/bin/python3.8 11
        - /usr/local/bin/pip3.8 install --user pipenv
        - amplifyPush --simple
```

### Cache
#### How do I reduce the cache size?

If you are using cache, you may be inadvertently caching intermediate files which aren't cleaned up between builds and bloat your cache. To omit certain folders, use the `!` directive, i.e.:

```yaml
cache:
  paths:
    - node_modules/**/*
    - "!node_modules/path/not/to/cache"
```

`node_modules/.cache` is omitted by default if you cache `node_modules`

#### How do I disable reading from cache?

If you ever specified a cache, it will continue to pull down the cache even if you remove the cache section from your buildspec.  To disable reading from cache, set the `AWS_CACHE_BUCKET_READ` environment variable to `false` in `App settings > Environment variables`

## Redirects

### Access denied for certain routes even with SPA redirect rule

This can also happen if your `baseDirectory` is not set correctly. For example, if your frontend is built to the `build` directory then your build settings will need to point to that or you will see this error.

For more information: https://docs.aws.amazon.com/amplify/latest/userguide/build-settings.html#yml-specification-syntax

```yaml
baseDirectory: build
files:
  - "**/*"
```

## Custom Domains

### How do I migrate domains to Amplify with minimal downtime?

The best process to follow to minimize downtime here would be:

1. In your Amplify Console app, open the domain management screen
2. Type in your root domain (yourdomain.com) and click configure
3. Click “Exclude root” button
4. Click “Remove” button next to the “www” sub domain that was automatically added
5. Add a subdomain that you don't use elsewhere for testing purposes
6. Click save

What we have now done, is started the process of creating and verifying a domain in Amplify Console, without adding any `CNAMEs` to the Amplify Console CloudFront Distribution.

Now follow the instructions for setting up the verification `CNAME` so that your new custom domain will receive a SSL certificate.

While this process is completing, please check the TTL on the DNS records you are moving to Amplify Console. You want them to be as small as possible so that the change propagates quickly. If you have to change this value, please be sure to wait out at minimum, the original TTL before continuing, to make sure that your new TTL is in effect.

Once that is done and the domain is marked as available, and you've tested with the extra sub domain you created in step 5 above, you’re now ready to do the migration.

You will need to do the following in quick succession:

- Change the DNS record (the records will all have the same destination as the subdomain you created for testing in step 5 above)
- Remove the CNAME from your CloudFront distribution.
- Add the CNAME to Amplify Console by going to the domain management page, and clicking “Manage subdomains”
- Doing it following this method you should see very little downtime, and will mainly depend on the TTL of the DNS record.

### CNAMEAlreadyExistsException

What this means: One of the hostnames you tried to connect (could be a subdomain, or the apex) is already deployed to a Cloudfront distribution.

https://docs.aws.amazon.com/amplify/latest/userguide/custom-domains.html#cnamealreadyexistsexception-error
https://aws.amazon.com/premiumsupport/knowledge-center/resolve-cnamealreadyexists-error/

These guides are helpful for getting started with custom domains, for existing domains there are number of steps that will need to be completed (as outlined in the docs above) depending on your current hosting and DNS providers.

A CNAME alias (mydomain.com, sub.mydomain.com) can only be associated with a single CloudFront distribution at a time, if you receive this error then the domain is already associated with another CF distribution (either within the same AWS account, or potentially in a different account) and must be disassociated from the previous distribution before the distribution created for you by Amplify Console will work, the docs help outline how to do this (and you may need to check more than one account if you or your organization owns multiple accounts)

If you manage your domain through Route53, make sure to clean up any hosted zone CNAME or ALIAS records that point to the old distribution. After completing the above, remove the custom domain from Amplify Console and start the flow over.

Initial troubleshooting steps:

- Is this domain connected to a different Amplify App that you own? If so, make sure you are not trying to reuse one of the hostnames.
  - If you are using www.domain.com on the other app, you cannot use www.domain.com on this app
  - You can use other hostnames, like blog.domain.com
- If you had this domain successfully connected to Amplify and then recently (within the last hour) deleted it, please wait and try again.
- Check the Cloudfront console to see if you have this domain deployed to any distributions
  If you are positive no CloudFront distribution exists (including in other accounts) using this domain, and only if it would not be disruptive to any currently running services, try deleting and recreating the hosted zone

## Web previews

Web previews is a feature to preview changes from pull requests (PRs) before merging them to an integration branch. A web preview deploys every pull request made to your repository to a unique preview URL which is different from the URL your main site uses. 

### Previews are not being created for new pull requests

Common reasons why pull requests previews may not be created: 

- The Amplify app has hit the [max branches per app](https://docs.aws.amazon.com/general/latest/gr/amplify.html) quota. Consider enabling branch auto deletion in your app so that you don't accumulate branches that no longer exist in your repo. 

- If you are using a public GitHub repository and your Amplify app has an IAM [service role](https://docs.aws.amazon.com/amplify/latest/userguide/how-to-service-role-amplify-console.html) associated to it, previews will not be created for security reasons. In this case, you can either disassociate the service role from your App if the app doesn't have a backend, or make the GitHub repository private. 


## SSR
**Amplify SSR Docs**: https://docs.aws.amazon.com/amplify/latest/userguide/server-side-rendering-amplify.html

With frameworks like Next.js you can create apps that are dynamic, use SSR (server side rendering), or static (SSG). If you create an SSG app and want to convert it to use SSR, you can follow our guide [here](https://docs.aws.amazon.com/amplify/latest/userguide/server-side-rendering-amplify.html#redeploy-ssg-to-ssr).

If you need to revert your app back to SSG, we suggest you delete your app and create a new one following the [guide](https://docs.aws.amazon.com/amplify/latest/userguide/server-side-rendering-amplify.html#deploy-nextjs-app) for how to get your app to be detected as SSG. **But if that is not an option and you need to revert existing app back to SSG**, please follow the guide below.

### Convert an SSR App to SSG
1. Run the following AWS CLI commands
```
aws amplify update-app --app-id <APP_ID> --platform WEB --region <REGION>
aws amplify update-branch --app-id <APP_ID> --branch-name <BRANCH_NAME> --framework 'Next.js - SSG' --region <REGION>
```
*Note, if your app uses an Amplify Backend, then set your framework field to be* 'Next.js - SSG - Amplify'

2. Update your build spec to point the 'baseDirectory' to 'out'. e.g.
```
version: 1
frontend:
  ...
  artifacts:
    baseDirectory: out
  ...
```

3. Update the build command in your package.json to use `next export`, then commit this to trigger a new non SSR build.

4. Finally, go to the `Rewrites and redirects` tab in the Amplify Console, and delete the first rewrite rule that was re-writing to your SSR CloudFront Distribution.
